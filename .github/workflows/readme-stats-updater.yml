name: Update README Stats

on:
  schedule:
    - cron: '0 16 * * *'  # 北京时间 00:00
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Stats SVG
        run: |
          wget -qO stats.svg "https://github-stats.waijade.cn/api?username=CheongSzesuen&show_icons=true&include_all_commits=true&theme=buefy&hide_border=true"

      - name: Extract Data from SVG (100% Stable with awk)
        id: stats
        run: |
          # 用 awk 提取所有数据（最稳定方式）
          RANK=$(awk -F'data-testid="level-rank-icon"' 'NF>1 {gsub(/.*>/, "", $2); gsub(/<.*/, "", $2); gsub(/[^A-Z]/, "", $2); print $2; exit}' stats.svg)
          STARS=$(awk -F'data-testid="stars"' 'NF>1 {gsub(/.*>/, "", $2); gsub(/<.*/, "", $2); gsub(/[^0-9]/, "", $2); print $2; exit}' stats.svg)
          COMMITS_RAW=$(awk -F'data-testid="commits"' 'NF>1 {gsub(/.*>/, "", $2); gsub(/<.*/, "", $2); gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2; exit}' stats.svg)
          PRS=$(awk -F'data-testid="prs"' 'NF>1 {gsub(/.*>/, "", $2); gsub(/<.*/, "", $2); gsub(/[^0-9]/, "", $2); print $2; exit}' stats.svg)
          ISSUES=$(awk -F'data-testid="issues"' 'NF>1 {gsub(/.*>/, "", $2); gsub(/<.*/, "", $2); gsub(/[^0-9]/, "", $2); print $2; exit}' stats.svg)

          # 处理 Commits 的 "k" 单位
          if [[ "$COMMITS_RAW" == *"k" ]]; then
            COMMITS=$(echo "$COMMITS_RAW" | sed 's/k//' | awk '{printf "%.0f", $1 * 1000}')
          else
            COMMITS=$COMMITS_RAW
          fi

          # 兜底（按你要求，保留“Action出错”）
          RANK=${RANK:-Action出错}
          STARS=${STARS:-Action出错}
          COMMITS=${COMMITS:-Action出错}
          PRS=${PRS:-Action出错}
          ISSUES=${ISSUES:-Action出错}

          # 输出
          echo "rank=$RANK" >> $GITHUB_OUTPUT
          echo "stars=$STARS" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT

          echo "=== Extracted Stats ==="
          echo "Rank: $RANK"
          echo "Stars: $STARS"
          echo "Commits: $COMMITS (from: $COMMITS_RAW)"
          echo "PRs: $PRS"
          echo "Issues: $ISSUES"

      - name: Update README.md
        run: |
          RANK="${{ steps.stats.outputs.rank }}"
          STARS="${{ steps.stats.outputs.stars }}"
          COMMITS="${{ steps.stats.outputs.commits }}"
          PRS="${{ steps.stats.outputs.prs }}"
          ISSUES="${{ steps.stats.outputs.issues }}"

          # 更新英文部分
          sed -i "s/^# My GitHub Stats([^)]*)/# My GitHub Stats($RANK)/" README.md
          sed -i "s/^# Total Stars Earned:.*/# Total Stars Earned: $STARS/" README.md
          sed -i "s/^# Total Commits:.*/# Total Commits: $COMMITS/" README.md
          sed -i "s/^# Total PRs:.*/# Total PRs: $PRS/" README.md
          sed -i "s/^# Total Issues:.*/# Total Issues: $ISSUES/" README.md

          # 更新中文部分
          sed -i "s/^# GitHub数据（[^）]*）/# GitHub数据（$RANK）/" README.md
          sed -i "s/^# 累计获得Stars：.*/# 累计获得Stars：$STARS/" README.md
          sed -i "s/^# 累计Commits：.*/# 累计Commits：$COMMITS/" README.md
          sed -i "s/^# 累计PRs：.*/# 累计PRs：$PRS/" README.md
          sed -i "s/^# 累计Issues：.*/# 累计Issues：$ISSUES/" README.md

      - name: Commit & Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: auto-update GitHub stats in README'
          file_pattern: README.md
